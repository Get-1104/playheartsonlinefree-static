(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function a(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=a(r);fetch(r.href,s)}})();const ve=["C","D","H","S"],Me=[2,3,4,5,6,7,8,9,10,11,12,13,14];function Ee(t,n){return{suit:t,rank:n}}function ee(t){const n=t.rank<=10?String(t.rank):t.rank===11?"J":t.rank===12?"Q":t.rank===13?"K":"A";return`${t.suit}${n}`}function ft(t,n){return t.suit===n.suit&&t.rank===n.rank}function Ie(t){const n=String(t);let a=2166136261;for(let o=0;o<n.length;o++)a^=n.charCodeAt(o),a=Math.imul(a,16777619);return a>>>0}function Le(t){let n=Ie(t);return{next(){n|=0,n=Math.imul(n+1831565813,1);let a=Math.imul(n^n>>>15,1|n);return a^=a+Math.imul(a^a>>>7,61|a),((a^a>>>14)>>>0)/4294967296},int(a){return Math.floor(this.next()*a)}}}function Re(){const t=[];for(const n of ve)for(const a of Me)t.push(Ee(n,a));return t}function _e(t,n){const a=Le(n),o=t.slice();for(let r=o.length-1;r>0;r--){const s=a.int(r+1);[o[r],o[s]]=[o[s],o[r]]}return o}function De(t){return[0,1,2,3].map(n=>t.slice(n*13,n*13+13))}

// Sort a hand into suit groups then rank (for better usability)
function zeHand(t){
  const n={C:0,D:1,S:2,H:3};
  return t.slice().sort((a,o)=>{
    const r=(n[a.suit] ?? 99) - (n[o.suit] ?? 99);
    return r!==0 ? r : (a.rank - o.rank);
  });
}
const Ne=[0,1,2,3];function He(){return{targetScore:100}}function Oe(t){const n=t%4;return n===0?"LEFT":n===1?"RIGHT":n===2?"ACROSS":"HOLD"}function dt(t,n){const a={...He(),...n??{}};return{seed:t,config:a,phase:"INIT_HAND",dealer:0,hand:null,seats:{0:{hand:[],taken:[],handScore:0,totalScore:0},1:{hand:[],taken:[],handScore:0,totalScore:0},2:{hand:[],taken:[],handScore:0,totalScore:0},3:{hand:[],taken:[],handScore:0,totalScore:0}}}}function Ye(t){const n=(t.hand?.handNo??-1)+1,a=Oe(n),o=_e(Re(),`${t.seed}#hand${n}`),r=De(o),s={...t.seats};for(const u of Ne)s[u]={...s[u],hand:zeHand(r[u]),taken:[],handScore:0};const l=(t.dealer+1)%4;return{...t,dealer:l,phase:a==="HOLD"?"PASS_RESOLVE":"PASS_SELECT",hand:{handNo:n,passDir:a,passSelected:{0:[],1:[],2:[],3:[]},heartsBroken:!1,currentPlayer:0,trickNo:0,trick:{leader:0,leadSuit:null,plays:[]}},seats:s,lastError:void 0}}function $e(t){return(t+1)%4}const yt=[0,1,2,3];function Be(t,n){switch(n){case"LEFT":return(t+1)%4;case"RIGHT":return(t+3)%4;case"ACROSS":return(t+2)%4;case"HOLD":return t;default:return t}}function We(t){const{passDir:n,selected:a}=t,o={0:t.hands[0].slice(),1:t.hands[1].slice(),2:t.hands[2].slice(),3:t.hands[3].slice()},r=n==="HOLD"?0:3;for(const s of yt){const l=a[s]??[];if(l.length!==r)throw new Error(`Player ${s} must select exactly ${r} cards`);for(const c of l)if(!o[s].some(f=>ft(f,c)))throw new Error(`Player ${s} selected card not in hand`)}if(r===0)return{hands:o};for(const s of yt){const l=a[s];for(const c of l){const f=o[s].findIndex(u=>ft(u,c));f>=0&&o[s].splice(f,1)}}for(const s of yt){const l=Be(s,n);o[l].push(...a[s])}for(const s of yt)if(o[s].length!==13)throw new Error(`After pass, player ${s} has ${o[s].length} cards`);return{hands:o}}function ne(t){return t.suit==="S"&&t.rank===12}function ae(t){return t.suit==="H"||ne(t)}function oe(t){let n=0;for(const a of t)a.suit==="H"?n+=1:ne(a)&&(n+=13);return n}function Ve(t){const{leadSuit:n,plays:a}=t;let o=a[0].player,r=-1;for(const s of a)s.card.suit===n&&s.card.rank>r&&(r=s.card.rank,o=s.player);return o}function zt(t,n){return t.some(a=>a.suit===n)}function Xe(t){return t.every(n=>ae(n))}function Ge(t){return t.suit==="C"&&t.rank===2}function Vt(t,n,a){if(t.phase!=="TRICK_PLAY")return"PLAY_CARD not allowed in this phase";if(!t.hand)return"No hand";if(n!==t.hand.currentPlayer)return"Not your turn";const o=t.seats[n].hand;if(!o.some(l=>ft(l,a)))return"Card not in hand";const r=t.hand.trick,s=r.plays.length===0;if(r.plays.length>=4)return"Trick complete";if(t.hand.trickNo===0&&s&&!Ge(a))return"First lead must be 2C";if(!s&&r.leadSuit&&zt(o,r.leadSuit)&&a.suit!==r.leadSuit)return"Must follow suit";if(t.hand.trickNo===0&&ae(a)&&r.leadSuit&&!zt(o,r.leadSuit)&&!Xe(o))return"No points on first trick unless no alternative";if(s&&a.suit==="H"&&!t.hand.heartsBroken&&!o.every(l=>l.suit==="H"))return"Hearts not broken"}function gt(t){return oe(t)}function Ke(t){const n=[0,1,2,3].find(o=>t[o]===26);if(n===void 0)return{...t};const a={0:0,1:0,2:0,3:0};for(const o of[0,1,2,3])a[o]=o===n?0:26;return a}function L(t,n){return{...t,lastError:n}}function Ue(t){for(const n of[0,1,2,3])if(t[n].hand.some(a=>a.suit==="C"&&a.rank===2))return n;return 0}function J(t,n,a){return n?null:L(t,a)}function re(t,n){switch(n.type){case"NEW_GAME":return dt(n.seed,n.config);case"NEW_HAND":{const a=J(t,t.phase==="INIT_HAND"||t.phase==="NEXT_HAND","NEW_HAND not allowed in this phase");return a||Ye(t)}case"SELECT_PASS":{if(!t.hand)return L(t,"No hand");const a=J(t,t.phase==="PASS_SELECT","SELECT_PASS not allowed in this phase");if(a)return a;const{player:o,cards:r}=n,s=t.hand.passDir==="HOLD"?0:3;if(r.length!==s)return L(t,`Must select exactly ${s} cards`);const l=t.seats[o].hand;for(const c of r)if(!l.some(u=>ft(u,c)))return L(t,"Selected card not in hand");return{...t,lastError:void 0,hand:{...t.hand,passSelected:{...t.hand.passSelected,[o]:r.slice()}}}}case"COMMIT_PASS":{if(!t.hand)return L(t,"No hand");const a=J(t,t.phase==="PASS_SELECT"||t.phase==="PASS_RESOLVE","COMMIT_PASS not allowed in this phase");if(a)return a;if(t.phase==="PASS_SELECT"){if((t.hand.passDir==="HOLD"?0:3)===3){for(const c of[0,1,2,3])if((t.hand.passSelected[c]??[]).length!==3)return L(t,"Not all players selected pass cards")}const s=We({passDir:t.hand.passDir,selected:t.hand.passSelected,hands:{0:t.seats[0].hand,1:t.seats[1].hand,2:t.seats[2].hand,3:t.seats[3].hand}}),l={...t.seats};for(const c of[0,1,2,3])l[c]={...l[c],hand:zeHand(s.hands[c])};return{...t,seats:l,phase:"PASS_RESOLVE",lastError:void 0}}const o=Ue(t.seats);return{...t,phase:"TRICK_PLAY",lastError:void 0,hand:{...t.hand,currentPlayer:o,trickNo:0,trick:{leader:o,leadSuit:null,plays:[]}}}}case"PLAY_CARD":{if(!t.hand)return L(t,"No hand");const a=J(t,t.phase==="TRICK_PLAY","PLAY_CARD not allowed in this phase");if(a)return a;const{player:o,card:r}=n,s=Vt(t,o,r);if(s)return L(t,s);const l=t.seats[o].hand,c=l.findIndex(k=>ft(k,r));if(c<0)return L(t,"Card not in hand");const f=l.slice();f.splice(c,1);const u={...t.seats};u[o]={...u[o],hand:zeHand(f)};const h=t.hand.trick.plays.concat([{player:o,card:r}]),d=t.hand.trick.leadSuit??r.suit,y=t.hand.heartsBroken||r.suit==="H",p=$e(t.hand.currentPlayer);return{...t,lastError:void 0,seats:u,hand:{...t.hand,heartsBroken:y,currentPlayer:p,trick:{...t.hand.trick,leadSuit:d,plays:h}}}}case"ADVANCE_TRICK":{if(!t.hand)return L(t,"No hand");const a=J(t,t.phase==="TRICK_PLAY","ADVANCE_TRICK not allowed in this phase");if(a)return a;if(t.hand.trick.plays.length!==4)return L(t,"Trick not complete");if(!t.hand.trick.leadSuit)return L(t,"No lead suit");const o=t.hand.trick.leadSuit,r=Ve({leadSuit:o,plays:t.hand.trick.plays}),s=t.hand.trick.plays.map(f=>f.card);oe(s);const l={...t.seats};l[r]={...l[r],taken:l[r].taken.concat(s)};const c=t.hand.trickNo+1;return c>=13?{...t,seats:l,phase:"HAND_SCORE",lastError:void 0,hand:{...t.hand,trick:{leader:r,leadSuit:null,plays:[]}}}:{...t,seats:l,lastError:void 0,hand:{...t.hand,trickNo:c,currentPlayer:r,trick:{leader:r,leadSuit:null,plays:[]}}}}case"SCORE_HAND":{const a=J(t,t.phase==="HAND_SCORE","SCORE_HAND not allowed in this phase");if(a)return a;if(!t.hand)return L(t,"No hand");const o={0:gt(t.seats[0].taken),1:gt(t.seats[1].taken),2:gt(t.seats[2].taken),3:gt(t.seats[3].taken)},r=Ke(o),s={...t.seats};for(const c of[0,1,2,3])s[c]={...s[c],handScore:r[c],totalScore:s[c].totalScore+r[c]};return[0,1,2,3].some(c=>s[c].totalScore>=t.config.targetScore)?{...t,seats:s,phase:"GAME_OVER",lastError:void 0}:{...t,seats:s,phase:"NEXT_HAND",lastError:void 0}}case"NEXT_HAND":{const a=J(t,t.phase==="NEXT_HAND","NEXT_HAND not allowed in this phase");return a||{...t,phase:"INIT_HAND",lastError:void 0}}default:return L(t,"Unknown action")}}const g=document.getElementById("game"),e=g.getContext("2d");let bt=null,lt=null;function Fe(){lt=document.createElement("canvas"),lt.width=320,lt.height=320;const a=lt.getContext("2d"),o=a.createLinearGradient(0,0,320,320);o.addColorStop(0,"#6a3f22"),o.addColorStop(.35,"#7a4a28"),o.addColorStop(.7,"#5b341c"),o.addColorStop(1,"#7d4e2b"),a.fillStyle=o,a.fillRect(0,0,320,320),a.save(),a.globalAlpha=.18,a.strokeStyle="#2b160c",a.lineWidth=1;for(let r=-40;r<360;r+=6){a.beginPath();for(let s=0;s<=320;s+=8){const l=r+Math.sin(s/320*Math.PI*2)*6+Math.sin(s/320*Math.PI*6)*2;s===0?a.moveTo(s,l):a.lineTo(s,l)}a.stroke()}a.restore(),a.save(),a.globalAlpha=.25;for(let r=0;r<6;r++){const s=Math.random()*320,l=Math.random()*320,c=18+Math.random()*36;a.strokeStyle="#3a1f12",a.lineWidth=1;for(let f=0;f<5;f++)a.beginPath(),a.ellipse(s,l,c+f*6,(c+f*6)*(.6+Math.random()*.3),Math.random(),0,Math.PI*2),a.stroke()}a.restore(),bt=e.createPattern(lt,"repeat")}function ze(){bt||Fe(),e.save(),e.setTransform(1,0,0,1,0,0),e.fillStyle=bt,e.fillRect(0,0,g.width,g.height);const t=e.createRadialGradient(g.width*.5,g.height*.45,Math.min(g.width,g.height)*.15,g.width*.5,g.height*.45,Math.max(g.width,g.height)*.75);t.addColorStop(0,"rgba(0,0,0,0)"),t.addColorStop(1,"rgba(0,0,0,0.35)"),e.fillStyle=t,e.fillRect(0,0,g.width,g.height),e.restore()}function qe(){const o=I-56,r=W-56,s=22,l=e.createLinearGradient(28,28,28,28+r);l.addColorStop(0,"#0f4a39"),l.addColorStop(1,"#083526"),e.save(),e.beginPath(),e.moveTo(28+s,28),e.arcTo(28+o,28,28+o,28+r,s),e.arcTo(28+o,28+r,28,28+r,s),e.arcTo(28,28+r,28,28,s),e.arcTo(28,28,28+o,28,s),e.closePath(),e.fillStyle=l,e.fill(),e.strokeStyle="rgba(0,0,0,0.35)",e.lineWidth=2,e.stroke(),e.restore()}const I=1e3,W=700;let Y={cssW:1e3,cssH:700,scale:1,ox:0,oy:0,dpr:1};function je(){const t=g.getBoundingClientRect(),n=Math.max(1,Math.floor(t.width)),a=Math.max(1,Math.floor(t.height)),o=Math.max(1,Math.min(3,window.devicePixelRatio||1)),r=Math.min(n/I,a/W),s=(n-I*r)/2,l=(a-W*r)/2;return{cssW:n,cssH:a,scale:r,ox:s,oy:l,dpr:o}}function se(){Y=je(),g.width=Math.floor(Y.cssW*Y.dpr),g.height=Math.floor(Y.cssH*Y.dpr),bt=null}function V(t,n){const a=g.getBoundingClientRect(),o=t-a.left,r=n-a.top;return{x:(o-Y.ox)/Y.scale,y:(r-Y.oy)/Y.scale}}let P={active:!1,startAt:0,intervalMs:70,total:52},tt=0;function Xt(){P.active=!0,P.startAt=performance.now(),tt=0}function qt(t){const n=Math.max(0,t-P.startAt),a=Math.min(P.total,Math.floor(n/P.intervalMs)),o=n/P.intervalMs-a;return{full:a,frac:Math.max(0,Math.min(1,o))}}let H=!1,z=.6,w=null,B=null;try{const t=window.localStorage.getItem("hearts:sfxMuted");t!=null&&(H=t==="1");const n=window.localStorage.getItem("hearts:sfxVolume");if(n!=null){const a=Number(n);Number.isFinite(a)&&(z=Math.max(0,Math.min(1,a)))}}catch{}let $=!0,D=null,q=.22;try{const t=window.localStorage.getItem("hearts:bgmOn");t!=null&&($=t==="1");const n=window.localStorage.getItem("hearts:bgmVolume");if(n!=null){const a=Number(n);Number.isFinite(a)&&(q=Math.max(0,Math.min(1,a)))}}catch{}function Je(){D||(D=new Audio("./audio/bgm.wav"),D.loop=!0,D.preload="auto",D.volume=Math.max(0,Math.min(1,q)))}function le(){if(Je(),!!D)if(D.volume=Math.max(0,Math.min(1,q)),$){const t=D.play();t&&typeof t.catch=="function"&&t.catch(()=>{})}else D.pause()}function ie(t){$=t;try{window.localStorage.setItem("hearts:bgmOn",$?"1":"0")}catch{}le()}function Qe(t){q=Math.max(0,Math.min(1,t));try{window.localStorage.setItem("hearts:bgmVolume",String(q))}catch{}D&&(D.volume=Math.max(0,Math.min(1,q)))}function Gt(){if(w)return;const t=window.AudioContext||window.webkitAudioContext;if(!t)return;w=new t;const n=w.createDynamicsCompressor();n.threshold.setValueAtTime(-20,w.currentTime),n.knee.setValueAtTime(18,w.currentTime),n.ratio.setValueAtTime(8,w.currentTime),n.attack.setValueAtTime(.003,w.currentTime),n.release.setValueAtTime(.15,w.currentTime),B=w.createGain();const a=(H?0:z)*3;B.gain.value=Math.max(0,Math.min(3,a)),B.connect(n),n.connect(w.destination)}function Ze(t){z=Math.max(0,Math.min(1,t));try{window.localStorage.setItem("hearts:sfxVolume",String(z))}catch{}if(B){const n=(H?0:z)*3;B.gain.value=Math.max(0,Math.min(3,n))}}function ce(t){H=t;try{window.localStorage.setItem("hearts:sfxMuted",t?"1":"0")}catch{}if(B){const n=(H?0:z)*3;B.gain.value=Math.max(0,Math.min(3,n))}}function x(t){if(H||(Gt(),!w||!B))return;w.state==="suspended"&&w.resume().catch(()=>{});const n=w.currentTime,a=w.createOscillator(),o=w.createGain();o.gain.value=0;let r=440,s=.03,l=.28;switch(t){case"click":r=720,s=.02,l=.22;break;case"deal":r=460,s=.018,l=.2;break;case"play":r=320,s=.035,l=.26;break;case"collect":r=190,s=.08,l=.32;break;case"pass":r=260,s=.045,l=.24;break;case"ok":r=520,s=.03,l=.24;break;case"bad":r=140,s=.055,l=.28;break}a.type="triangle",a.frequency.setValueAtTime(r,n),o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(l,n+.005),o.gain.exponentialRampToValueAtTime(1e-4,n+s),a.connect(o),o.connect(B),a.start(n),a.stop(n+s+.02)}function fe(t){return[0,1,2,3].map(n=>t.seats[n].totalScore)}function tn(t){const n=t.players;return n&&Array.isArray(n)?n.map(a=>typeof a.taken=="number"?a.taken:typeof a.handScore=="number"?a.handScore:Array.isArray(a.taken)?a.taken.length:0):[0,1,2,3].map(a=>t.seats[a].handScore)}function en(t,n){const a=n.scale*n.dpr;t.setTransform(a,0,0,a,n.ox*n.dpr,n.oy*n.dpr)}let i=dt("ui-seed"),Q=!1;se();let Lt=!1;function Kt(){Lt||(Lt=!0,requestAnimationFrame(()=>{Lt=!1,se()}))}window.addEventListener("resize",Kt);window.visualViewport?.addEventListener?.("resize",Kt);try{new ResizeObserver(()=>Kt()).observe(g)}catch{}try{window.parent?.postMessage({type:"hearts:ready"},"*")}catch{}const m=0,de=["You","Alex","Morgan","Sam"],Ht=[{color:"#f4d03f",label:"Y",src:"./avatars/you.png"},{color:"#5dade2",label:"A",src:"./avatars/alex.png"},{color:"#58d68d",label:"M",src:"./avatars/morgan.png"},{color:"#ec7063",label:"S",src:"./avatars/sam.png"}],Ot=[null,null,null,null];function nn(){for(let t=0;t<Ht.length;t++){const n=Ht[t],a=new Image;a.decoding="async",a.src=n.src,a.onload=()=>{Ot[t]=a,S()},a.onerror=()=>{Ot[t]=null}}}nn();function an(t,n,a,o){const r=Ht[t],s=Ot[t];e.save(),e.shadowColor="rgba(0,0,0,0.35)",e.shadowBlur=10,e.shadowOffsetY=3,e.beginPath(),e.arc(n,a,o,0,Math.PI*2),e.closePath(),e.clip(),s&&s.complete&&s.naturalWidth>0?e.drawImage(s,n-o,a-o,o*2,o*2):(e.fillStyle=r.color,e.fillRect(n-o,a-o,o*2,o*2),e.fillStyle="#fff",e.font=`bold ${Math.max(12,Math.floor(o*1.1))}px system-ui, -apple-system, Segoe UI, sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(r.label,n,a+1)),e.restore(),e.save(),e.strokeStyle="rgba(255,255,255,0.25)",e.lineWidth=2,e.beginPath(),e.arc(n,a,o+.5,0,Math.PI*2),e.stroke(),e.strokeStyle="rgba(0,0,0,0.25)",e.lineWidth=2,e.beginPath(),e.arc(n,a,o+1.5,0,Math.PI*2),e.stroke(),e.restore()}function E(t,n,a){return t>=a.x&&t<=a.x+a.w&&n>=a.y&&n<=a.y+a.h}function Yt(t,n,a){const o=a?.enabled!==!1,r=a?.variant??"ivory",s=12;e.save(),e.globalAlpha=o?1:.75,e.shadowColor="rgba(0,0,0,0.55)",e.shadowBlur=10,e.shadowOffsetY=4;const l=e.createLinearGradient(t.x,t.y,t.x,t.y+t.h);r==="gold"?(l.addColorStop(0,o?"#fff2b8":"#d7d0b2"),l.addColorStop(.55,o?"#f1cf63":"#c3b48a"),l.addColorStop(1,o?"#c79a2c":"#9f956f")):r==="dark"?(l.addColorStop(0,o?"rgba(30,30,30,0.92)":"rgba(35,35,35,0.78)"),l.addColorStop(1,o?"rgba(10,10,10,0.92)":"rgba(15,15,15,0.78)")):(l.addColorStop(0,o?"#ffffff":"#dcdcdc"),l.addColorStop(1,o?"#e7e7e7":"#c9c9c9")),e.fillStyle=l,N(e,t.x,t.y,t.w,t.h,s),e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetY=0,e.lineWidth=2,e.strokeStyle=r==="gold"?"rgba(60,40,10,0.75)":r==="dark"?"rgba(255,255,255,0.22)":"rgba(0,0,0,0.28)",N(e,t.x,t.y,t.w,t.h,s),e.stroke(),e.textAlign="center",e.textBaseline="middle",e.shadowColor="transparent",e.fillStyle=r==="dark"?"rgba(255,255,255,0.92)":"#111",e.font="18px system-ui, -apple-system, Segoe UI, sans-serif",e.fillText(n,t.x+t.w/2,t.y+t.h/2+.5),e.restore()}function on(t,n){const a=t.x+t.w/2,o=t.y+t.h/2;e.save(),e.translate(a,o),e.strokeStyle=n?"rgba(20,20,20,0.95)":"rgba(255,255,255,0.92)",e.fillStyle=e.strokeStyle,e.lineWidth=3,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(-2,-10),e.lineTo(-2,6),e.stroke(),e.beginPath(),e.moveTo(-2,-10),e.quadraticCurveTo(10,-8,10,-2),e.stroke(),e.beginPath(),e.arc(-6,10,5.5,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(10,6,5.5,0,Math.PI*2),e.fill(),e.restore()}function rn(t,n){const a=t.x+t.w/2,o=t.y+t.h/2;e.save(),e.translate(a,o),e.strokeStyle=n?"rgba(20,20,20,0.95)":"rgba(255,255,255,0.92)",e.fillStyle=e.strokeStyle,e.lineWidth=3,e.lineCap="round",e.lineJoin="round",e.beginPath(),e.moveTo(-12,-6),e.lineTo(-6,-6),e.lineTo(2,-12),e.lineTo(2,12),e.lineTo(-6,6),e.lineTo(-12,6),e.closePath(),e.fill(),n?(e.beginPath(),e.arc(6,0,7,-.6,.6),e.stroke(),e.beginPath(),e.arc(6,0,12,-.6,.6),e.stroke()):(e.beginPath(),e.moveTo(7,-7),e.lineTo(17,7),e.moveTo(17,-7),e.lineTo(7,7),e.stroke()),e.restore()}function et(t,n,a){const o=a?.enabled!==!1,r=a?.variant??"ivory",s=14;e.save(),e.globalAlpha=o?1:.78,e.shadowColor="rgba(0,0,0,0.55)",e.shadowBlur=10,e.shadowOffsetY=4;const l=e.createLinearGradient(t.x,t.y,t.x,t.y+t.h);r==="gold"?(l.addColorStop(0,o?"#fff2b8":"#d7d0b2"),l.addColorStop(.55,o?"#f1cf63":"#c3b48a"),l.addColorStop(1,o?"#c79a2c":"#9f956f")):r==="dark"?(l.addColorStop(0,o?"rgba(30,30,30,0.92)":"rgba(35,35,35,0.78)"),l.addColorStop(1,o?"rgba(10,10,10,0.92)":"rgba(15,15,15,0.78)")):(l.addColorStop(0,o?"#ffffff":"#dcdcdc"),l.addColorStop(1,o?"#e7e7e7":"#c9c9c9")),e.fillStyle=l,N(e,t.x,t.y,t.w,t.h,s),e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetY=0,e.lineWidth=2,r==="gold"?e.strokeStyle="rgba(60,40,10,0.75)":r==="dark"?e.strokeStyle="rgba(255,255,255,0.22)":e.strokeStyle="rgba(0,0,0,0.28)",N(e,t.x,t.y,t.w,t.h,s),e.stroke(),e.globalAlpha=o?.35:.2,e.strokeStyle="rgba(255,255,255,0.75)",e.lineWidth=1,N(e,t.x+2,t.y+2,t.w-4,t.h-4,s-2),e.stroke(),e.globalAlpha=1,e.shadowColor="transparent",e.textAlign="center",e.textBaseline="middle",e.fillStyle=r==="dark"?"rgba(255,255,255,0.92)":"#111",e.font=a?.font??"16px system-ui, -apple-system, Segoe UI, sans-serif",!!a?.icon?(e.font="18px system-ui, -apple-system, Segoe UI, sans-serif",e.fillText(a.icon,t.x+t.w/2,t.y+t.h/2-9),e.font=a?.font??"13px system-ui, -apple-system, Segoe UI, sans-serif",e.fillText(n,t.x+t.w/2,t.y+t.h/2+12)):e.fillText(n,t.x+t.w/2,t.y+t.h/2+.5),e.restore()}function ue(){return{x:(I-220)/2,y:420,w:220,h:54}}function sn(){e.save(),e.fillStyle="rgba(0,0,0,0.18)",e.fillRect(0,0,I,W),e.fillStyle="rgba(255,255,255,0.95)",e.textAlign="center",e.textBaseline="middle",e.font="34px system-ui, -apple-system, Segoe UI, sans-serif",e.fillText("HEARTS",I/2,240),e.font="16px system-ui, -apple-system, Segoe UI, sans-serif",e.fillStyle="rgba(255,255,255,0.85)",e.fillText("Single-player • 4 players",I/2,274),Bt(I/2,340);const t=ue();et(t,"START",{variant:"gold",font:"18px system-ui, -apple-system, Segoe UI, sans-serif"}),e.restore()}const he={C:"♣",D:"♦",H:"♥",S:"♠"},ln={C:"Clubs",D:"Diamonds",H:"Hearts",S:"Spades"};function wt(t){return he[t??""]??"?"}function cn(t){return ln[t??""]??""}function fn(t){return t==="H"||t==="D"}function dn(t,n,a,o,r="left"){const s=wt(o);t.save(),t.textAlign=r;const l=fn(o),c=l?"#ff4d4d":"#111111",f=l?"rgba(0,0,0,0.35)":"rgba(255,255,255,0.55)";t.lineWidth=3,t.strokeStyle=f,t.strokeText(s,n,a),t.fillStyle=c,t.fillText(s,n,a),t.restore()}function $t(t,n,a,o,r,s="",l="left"){t.save(),t.textAlign=l;const c=t.measureText(o).width,f=t.measureText(wt(r)).width,u=s?t.measureText(s).width:0;let h=n;l==="center"&&(h=n-(c+f+u)/2),l==="right"&&(h=n-(c+f+u)),t.fillStyle="#ffffff",t.fillText(o,h,a);const d=h+c;dn(t,d,a,r,"left"),s&&(t.fillStyle="#ffffff",t.fillText(s,d+f,a)),t.restore()}const St=new URLSearchParams(window.location.search).get("debug")==="1";function un(t){const n=t[0]??"C",a=t.slice(1)||"?",o=he[n]??"?",r=n==="H"||n==="D";return{suit:n,rank:a,label:`${a}${o}`,color:r?"#c0392b":"#111111"}}function pe(t,n,a,o,r,s){const{label:l,color:c}=un(r),f=!!s?.selected,u=!!s?.disabled;e.save(),u&&(e.globalAlpha=.45),e.fillStyle="#f7f7f7",e.strokeStyle=f?"#f1c40f":"#222",e.lineWidth=f?3:1,e.fillRect(t,n,a,o),e.strokeRect(t,n,a,o),e.fillStyle=c,e.font="14px system-ui, -apple-system, Segoe UI, sans-serif",e.textAlign="left",e.textBaseline="top",e.fillText(l,t+6,n+6);const h=l.slice(-1);e.font="34px serif",e.textAlign="center",e.textBaseline="middle",e.fillText(h,t+a/2,n+o/2+4),e.translate(t+a,n+o),e.rotate(Math.PI),e.textAlign="left",e.textBaseline="top",e.font="14px system-ui, -apple-system, Segoe UI, sans-serif",e.fillText(l,6,6),e.restore()}function mt(t,n,a,o,r){const s=Math.max(0,Math.min(r,Math.min(a,o)/2));e.beginPath(),e.moveTo(t+s,n),e.arcTo(t+a,n,t+a,n+o,s),e.arcTo(t+a,n+o,t,n+o,s),e.arcTo(t,n+o,t,n,s),e.arcTo(t,n,t+a,n,s),e.closePath()}function N(t,n,a,o,r,s){const l=Math.max(0,Math.min(s,Math.min(o,r)/2));t.beginPath(),t.moveTo(n+l,a),t.arcTo(n+o,a,n+o,a+r,l),t.arcTo(n+o,a+r,n,a+r,l),t.arcTo(n,a+r,n,a,l),t.arcTo(n,a,n+o,a,l),t.closePath()}function ut(t,n,a,o,r,s){e.save(),e.translate(t,n),e.rotate(r),e.translate(-a/2,-o/2),e.save(),e.globalAlpha=.22,e.fillStyle="#000",mt(3,4,a,o,8),e.fill(),e.restore(),e.globalAlpha=1,e.fillStyle="#1f4f8a",e.strokeStyle="#0d1b2a",e.lineWidth=1.5,mt(0,0,a,o,8),e.fill(),e.stroke(),e.save(),e.strokeStyle="rgba(255,255,255,0.55)",e.lineWidth=1,mt(5,5,a-10,o-10,6),e.stroke(),e.restore(),e.save(),mt(0,0,a,o,8),e.clip(),e.globalAlpha=.2,e.strokeStyle="#ffffff",e.lineWidth=1;const l=10;for(let c=-o;c<a+o;c+=8)e.beginPath(),e.moveTo(c,l),e.lineTo(c+o,o-l),e.stroke();e.restore(),e.save(),e.globalAlpha=.28,e.fillStyle="#ffffff",e.font="24px serif",e.textAlign="center",e.textBaseline="middle",e.fillText("♥",a/2,o/2+1),e.restore(),e.restore()}function pt(){return{x:I-40-14,y:14,w:40,h:40}}let R=!1;function G(){const t=pt(),n=320,a=240,o=t.x+t.w-n,r=t.y+t.h+10;return{x:o,y:r,w:n,h:a}}function ye(){const t=G();return{x:t.x+16,y:t.y+74,w:44,h:44}}function ge(){const t=G();return{x:t.x+16,y:t.y+18,w:44,h:44}}function Ct(){const t=G(),n=t.x+16+44+12;return{x:n,y:t.y+30,w:t.w-(n-t.x)-16,h:20}}function vt(){const t=G(),n=t.x+16+44+12;return{x:n,y:t.y+86,w:t.w-(n-t.x)-16,h:20}}function Se(){const t=G();return{x:t.x+16,y:t.y+166,w:t.w-32,h:44}}let nt=null;function ht(t,n){const a=t==="bgm"?Ct():vt(),o=14,r=0,s=a.x+o,l=Math.max(1,a.w-o*2-r),c=(n-s)/l;t==="bgm"?(Qe(c),!$&&q>.001&&ie(!0)):(Ze(c),H&&z>.001&&ce(!1))}let X=null;function Tt(t,n,a){return Number.isFinite(t)?Math.max(n,Math.min(a,Math.trunc(t))):n}function hn(){const t=new URL(window.location.href).searchParams,n=f=>{try{return window.localStorage.getItem(f)}catch{return null}},a=t.get("pacing")??n("hearts:pacing"),o=a==null?!0:a!=="0",r=t.get("trick")??n("hearts:trickPauseMs"),s=t.get("bot")??n("hearts:botBaseDelayMs"),l=Tt(Number(r??700),0,3e3),c=Tt(Number(s??180),0,2e3);return{enabled:o,trickPauseMs:l,botBaseDelayMs:c}}let _=hn();try{window.__heartsUiPacing={get:()=>_,set:t=>{_={enabled:typeof t.enabled=="boolean"?t.enabled:_.enabled,trickPauseMs:typeof t.trickPauseMs=="number"?Tt(t.trickPauseMs,0,3e3):_.trickPauseMs,botBaseDelayMs:typeof t.botBaseDelayMs=="number"?Tt(t.botBaseDelayMs,0,2e3):_.botBaseDelayMs}}}}catch{}let Pt=0,Z=!1,it=null;function at(){return P.active||Z||Date.now()<Pt}function pn(){Z=!1,Pt=0,it!=null&&(clearTimeout(it),it=null)}function Ut(t=_.trickPauseMs){if(!Z){if(!_.enabled||t<=0){Z=!1,Pt=0,A({type:"ADVANCE_TRICK"});return}Z=!0,Pt=Date.now()+t,it=window.setTimeout(()=>{it=null,Z=!1,A({type:"ADVANCE_TRICK"})},t)}}function kt(t=0){if(!_.enabled)return 0;const n=_.botBaseDelayMs;return t<=0?n:n+Math.floor(Math.random()*(t+1))}let O=!1,M="",T=[],j=null;function jt(){T=[],j=null,X=null}g.addEventListener("mousedown",t=>{const{x:n,y:a}=V(t.clientX,t.clientY);if(Gt(),R&&E(n,a,Ct())){nt="bgm",ht("bgm",n),x("click"),S(),t.preventDefault(),t.stopImmediatePropagation();return}R&&E(n,a,vt())&&(nt="sfx",ht("sfx",n),x("click"),S(),t.preventDefault(),t.stopImmediatePropagation())},!0);g.addEventListener("mousemove",t=>{if(!nt)return;const{x:n}=V(t.clientX,t.clientY);ht(nt,n),S()},!0);window.addEventListener("mouseup",()=>{nt&&(nt=null)});g.addEventListener("click",t=>{const{x:n,y:a}=V(t.clientX,t.clientY);if(Gt(),$&&le(),!Q&&E(n,a,ue())){x("click"),R=!1,Q=!0,i=re(dt(String(Date.now())),{type:"NEW_HAND"}),Xt(),jt(),S(),t.stopImmediatePropagation();return}if(E(n,a,pt())){x("click"),R=!R,S(),t.stopImmediatePropagation();return}if(R){const o=G();if(!E(n,a,o)){R=!1,S(),t.stopImmediatePropagation();return}if(E(n,a,ye())){x("click"),ce(!H),S(),t.stopImmediatePropagation();return}if(E(n,a,ge())){x("click"),ie(!$),S(),t.stopImmediatePropagation();return}if(E(n,a,Ct())){x("click"),ht("bgm",n),S(),t.stopImmediatePropagation();return}if(E(n,a,vt())){x("click"),ht("sfx",n),S(),t.stopImmediatePropagation();return}if(E(n,a,Se())){x("click"),R=!1,Q=!1,P.active=!1,tt=0,i=dt(String(Date.now())),jt(),S(),t.stopImmediatePropagation();return}}},!0);let Jt=null,Qt="",me=Date.now();function yn(t){const n=t.hand?.trick?.plays?.length??0,a=t.hand?.currentPlayer??-1,o=tn(t).join(","),r=fe(t).join(",");return`${t.phase}|${a}|${n}|${o}|${r}`}function gn(t){if(!t.hand||t.phase!=="TRICK_PLAY")return t;let n=!1,a=t.hand,o=a.trick;return o.plays.length>0&&o.leadSuit==null&&(o={...o,leadSuit:o.plays[0].card.suit},n=!0),o.plays.length===0&&a.currentPlayer!==o.leader&&(a={...a,currentPlayer:o.leader},n=!0),n?{...t,hand:{...a,trick:o}}:t}function Sn(){const t=yn(i);t!==Qt&&(Qt=t,me=Date.now())}function A(t){try{const n=i.phase,a=i.hand?.trick?.plays?.length??0;(t.type==="NEW_GAME"||t.type==="NEW_HAND")&&pn(),i=re(i,t),i=gn(i),Jt=null,Sn(),t.type==="PLAY_CARD"&&x("play"),t.type==="COMMIT_PASS"&&x("pass");const o=i.hand?.trick?.plays?.length??0;n==="TRICK_PLAY"&&a===4&&o===0&&x("collect"),t.type==="NEW_HAND"&&Xt();try{i.phase==="GAME_OVER"&&window.parent?.postMessage({type:"hearts:game_over",totals:fe(i)},"*")}catch{}be()}catch(n){Jt=String(n?.message??n)}}function mn(t){return t.phase}function kn(t){return t.hand?.currentPlayer??null}function xt(t,n){return t.seats[n]?.hand??[]}function ke(t,n){return{type:"PLAY_CARD",player:t,card:n}}function Zt(t,n){return{type:"SELECT_PASS",player:t,cards:n}}function Mt(t,n,a){return Vt(t,n,a)===void 0}function xe(t,n){return t.slice().sort((a,o)=>a.rank-o.rank||a.suit.localeCompare(o.suit)).slice(0,n)}function xn(){let t=0;for(;t<10;){if(i.phase==="HAND_SCORE"){A({type:"SCORE_HAND"}),t++;continue}break}}function be(){if(O||at())return;xn();const t=mn(i);if(M&&!(M.startsWith("PASS|")&&t==="PASS_SELECT")&&!(M.startsWith("TRICK|")&&t==="TRICK_PLAY")&&!(M.startsWith("PASS_RESOLVE|")&&t==="PASS_RESOLVE")&&(M=""),t==="PASS_SELECT"){const f=i.hand?.passDir==="HOLD"?0:3;if(f===0){O=!0,setTimeout(()=>{try{A({type:"COMMIT_PASS"}),i.phase==="PASS_RESOLVE"&&A({type:"COMMIT_PASS"})}finally{O=!1}},kt(80));return}const u=i.hand?.passSelected[1]?.length??0,h=i.hand?.passSelected[2]?.length??0,d=i.hand?.passSelected[3]?.length??0,y=`PASS|${u}|${h}|${d}`;if(y===M)return;M=y;let p=null;if(u!==f?p=1:h!==f?p=2:d!==f&&(p=3),p!==null){const k=y;O=!0,setTimeout(()=>{try{if(!i.hand||i.phase!=="PASS_SELECT")return;const C=i.hand.passDir==="HOLD"?0:3;if((i.hand.passSelected[p]??[]).length===C||k!==M)return;const b=xe(xt(i,p),C);A({type:"SELECT_PASS",player:p,cards:b})}finally{O=!1}},kt(80))}return}if(t==="PASS_RESOLVE"){const f=`PASS_RESOLVE|${i.hand?.passDir??"?"}|${i.seats[0].hand.length}|${i.seats[1].hand.length}|${i.seats[2].hand.length}|${i.seats[3].hand.length}`;if(f===M)return;M=f,O=!0,setTimeout(()=>{try{if(i.phase!=="PASS_RESOLVE")return;A({type:"COMMIT_PASS"})}finally{O=!1}},kt(40));return}if(t!=="TRICK_PLAY")return;const n=kn(i);if(n==null||n===m)return;const a=`TRICK|${n}|${i.hand?.trick.plays.length??0}|${xt(i,n).length}`;if(a===M)return;M=a;const o=xt(i,n);if(!o.length)return;const r=o.filter(f=>Mt(i,n,f));if(!r.length){i.lastError=i.lastError??`No legal moves for P${n}`;return}const s=r[0],l=a;O=!0;const c=kt(130);setTimeout(()=>{try{if(i.phase!=="TRICK_PLAY"||!i.hand||i.hand.currentPlayer!==n||l!==M)return;A(ke(n,s)),i.phase==="TRICK_PLAY"&&i.hand?.trick.plays.length===4&&Ut()}finally{O=!1}},c)}function we(t){switch(t){case 0:return{x:500,y:620,align:"center"};case 1:return{x:860,y:345,align:"left"};case 2:return{x:500,y:72,align:"center"};case 3:return{x:80,y:345,align:"right"}}}function F(t,n){const a=we(t),o=16,r=t===0?{dx:-60,dy:-12}:t===1?{dx:62,dy:-22}:t===2?{dx:-60,dy:-12}:{dx:-66,dy:-22};an(t,a.x+r.dx,a.y+r.dy,o);const s=i.hand?.currentPlayer===t&&i.phase==="TRICK_PLAY";e.font="16px sans-serif",e.textAlign=a.align,e.fillStyle=s?"#ffe08a":"#ffffff";const l=i.seats[t],c=de[t],u=`Hand:${typeof n=="number"?n:l.hand.length}  Taken:${l.taken.length}`,h=`This:${l.handScore}  Total:${l.totalScore}`;e.fillText(c,a.x,a.y),e.font="14px sans-serif",e.fillText(u,a.x,a.y+20),e.fillText(h,a.x,a.y+40)}function Rt(t){F(0,t?.[0]),F(1,t?.[1]),F(2,t?.[2]),F(3,t?.[3])}function bn(t,n,a){let o=500,r=360,s=0,l=0,c=0;t===2?(o=500,r=155,s=Math.PI,l=24,c=0):t===1?(o=820,r=330,s=-Math.PI/2,l=0,c=16):t===3&&(o=180,r=330,s=Math.PI/2,l=0,c=16);const f=o-l*(a-1)/2,u=r-c*(a-1)/2,h=f+n*l,d=u+n*c,y=n/(a-1)*2-1,p=1-y*y,k=s+y*.24,C=18*p,v=t===1?-C:t===3?C:0,b=t===2?C:0;return{cx:h+v,cy:d+b,rot:k}}function wn(t,n){return{cx:160+t*55+24,cy:520+35,rot:0}}function _t(t,n,a){return t+(n-t)*a}function Bt(t,n){for(let r=3;r>=0;r--)ut(t+r*1.2,n+r*1.2,46,66,-.15)}function Dt(t){const o=(c,f)=>{if(c===m)return;const u=Math.max(0,Math.min(f,13));if(u===0)return;let h=500,d=360,y=0,p=0,k=0;c===2?(h=500,d=155,y=Math.PI,p=24,k=0):c===1?(h=820,d=330,y=-Math.PI/2,p=0,k=16):c===3&&(h=180,d=330,y=Math.PI/2,p=0,k=16);const C=h-p*(u-1)/2,v=d-k*(u-1)/2;for(let b=0;b<u;b++){const K=C+b*p,ot=v+b*k,U=u<=1?0:b/(u-1)*2-1,rt=1-U*U,st=y+U*.24,It=18*rt,Ae=c===1?-It:c===3?It:0,Ce=c===2?It:0;ut(K+Ae,ot+Ce,46,66,st)}},r=t?.[1]??i.seats[1].hand.length,s=t?.[2]??i.seats[2].hand.length,l=t?.[3]??i.seats[3].hand.length;o(1,r),o(2,s),o(3,l)}function Nt(){if(!i.hand)return;for(const n of i.hand.trick.plays){const a=n.player,o=we(a),r=a===0||a===2?0:a===1?-70:55,s=a===0?-140:a===2?90:-20,l=o.x+r,c=o.y+s;pe(l-25,c-35,50,70,ee(n.card))}e.textAlign="center",e.font="14px sans-serif",e.fillStyle="#ffffff";const t=i.hand.trick.leadSuit;t?$t(e,500,270,"Lead: ",t,"","center"):e.fillText("Lead: —",500,270)}function te(){const t=i.seats[m].hand;e.textAlign="left",e.font="12px monospace";const n=i.phase==="TRICK_PLAY"&&!!i.hand&&i.hand.currentPlayer===m;for(let a=0;a<t.length;a++){const o=t[a],r=160+a*55,s=520,l=n&&j===a,c=l?18:0,f=X===a,u=f?55:48,h=f?78:70,d=r-(f?3:0),y=s-(f?6:0),p=!Mt(i,m,o),k=i.phase==="PASS_SELECT"&&T.includes(a)||l,C=i.phase==="TRICK_PLAY"&&!n||n&&p;pe(d,y-c,u,h,ee(o),{selected:k,disabled:C})}}function Tn(t){const n=Math.max(0,Math.min(t,13));for(let a=0;a<n;a++){const o=160+a*55;ut(o+24,520+35,46,66,0)}}function Pn(){e.textAlign="left",e.font="14px sans-serif",e.fillStyle="#ffffff";const t=i.lastError?`Error: ${i.lastError}`:"",n=i.hand?i.hand.trickNo+1:0,a=i.hand?i.hand.heartsBroken:!1,o=i.hand?.trick.leadSuit??null;if(St){const s=`Phase: ${i.phase}`,l=i.hand?`Current: P${i.hand.currentPlayer}`:"Current: -",c=i.hand?`Trick: ${n}/13`:"",f=i.hand?`HeartsBroken: ${a?"Y":"N"}`:"",u=_.enabled?`Pace:${_.trickPauseMs}ms Bot:${_.botBaseDelayMs}ms`:"Pace:off";e.fillText(`${s} | ${l} | ${c}${f?" | "+f:""} | ${u}`,20,22),t&&e.fillText(t,20,44)}else{const s=i.phase==="TRICK_PLAY"&&i.hand&&i.hand.currentPlayer===m,l=i.hand?`Trick ${n} / 13${s?" • Your turn":""}`:"";o&&`${wt(o)}`;const c=`Hearts: ${a?"Yes":"No"}`;e.fillText(`${l}`,20,22),o?$t(e,20,44,"Lead ",o,` • ${c}`,"left"):e.fillText(`Lead — • ${c}`,20,44),t&&e.fillText(t,20,66)}if(i.phase==="TRICK_PLAY"&&i.hand&&i.hand.currentPlayer===m){const s=i.hand.trick.leadSuit,l=s?St?`You must follow: ${wt(s)} (${cn(s)})`:"":St?"You lead":"Your lead";let c="";if(X!==null){const u=i.seats[m].hand[X],h=u?Vt(i,m,u):void 0;h&&(c=` — ${h}`)}const f=66;!St&&s?$t(e,20,f,"Follow ",s,c,"left"):e.fillText(l+c,20,f)}const r=pt();Yt(r,"⚙",{variant:"gold"}),e.restore()}function ct(){if(!R)return;const t=G();e.save(),e.fillStyle="rgba(0,0,0,0.18)",e.fillRect(0,0,I,W);const n=16,a=e.createLinearGradient(t.x,t.y,t.x,t.y+t.h);a.addColorStop(0,"rgba(24,26,26,0.92)"),a.addColorStop(1,"rgba(12,13,13,0.92)"),e.fillStyle=a,N(e,t.x,t.y,t.w,t.h,n),e.fill(),e.lineWidth=1,e.strokeStyle="rgba(255,255,255,0.18)",N(e,t.x,t.y,t.w,t.h,n),e.stroke();const o=ge();Yt(o,"",{variant:$?"ivory":"dark"}),on(o,$);const r=ye();Yt(r,"",{variant:H?"dark":"ivory"}),rn(r,!H);const s=(d,y)=>{e.fillStyle="rgba(0,0,0,0.30)",N(e,d.x,d.y,d.w,d.h,10),e.fill(),e.strokeStyle="rgba(255,255,255,0.14)",e.lineWidth=1,N(e,d.x,d.y,d.w,d.h,10),e.stroke();const k=14,C=0,v=d.x+k,b=Math.max(1,d.w-k*2-C),K=d.y+d.h/2,ot=Math.max(0,Math.min(1,y)),U=e.createLinearGradient(v,d.y,v,d.y+d.h);U.addColorStop(0,"#fff2b8"),U.addColorStop(.55,"#f1cf63"),U.addColorStop(1,"#c79a2c"),e.strokeStyle=U,e.lineWidth=6,e.lineCap="round",e.beginPath(),e.moveTo(v,K),e.lineTo(v+b*ot,K),e.stroke(),e.strokeStyle="rgba(255,255,255,0.18)",e.lineWidth=6,e.beginPath(),e.moveTo(v+b*ot,K),e.lineTo(v+b,K),e.stroke();const rt=v+b*ot;e.save(),e.shadowColor="rgba(0,0,0,0.55)",e.shadowBlur=8,e.shadowOffsetY=3;const st=e.createLinearGradient(rt,d.y,rt,d.y+d.h);return st.addColorStop(0,"#ffffff"),st.addColorStop(1,"#dcdcdc"),e.fillStyle=st,e.beginPath(),e.arc(rt,K,10,0,Math.PI*2),e.fill(),e.shadowColor="transparent",e.strokeStyle="rgba(0,0,0,0.22)",e.lineWidth=2,e.stroke(),e.restore(),{trackY:K,rightX:d.x+d.w-14,pctX:d.x+d.w-14}},l=Ct();s(l,$?q:0);const f=vt();s(f,H?0:z),e.strokeStyle="rgba(255,255,255,0.10)",e.beginPath(),e.moveTo(t.x+14,t.y+66),e.lineTo(t.x+t.w-14,t.y+66),e.stroke();const h=Se();et(h,"NEW GAME",{variant:"gold",font:"15px system-ui, -apple-system, Segoe UI, sans-serif"}),e.fillStyle="rgba(255,255,255,0.55)",e.font="11px sans-serif",e.textAlign="left",e.textBaseline="alphabetic",e.restore()}function Wt(){if(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,g.width,g.height),ze(),en(e,Y),qe(),Pn(),!Q){Bt(500,350),ct();return}let t=null;if(P.active){const{full:n}=qt(performance.now()),a=Math.min(P.total,n),o=Math.floor(a/4),r=a%4;t={0:o+(r>0?1:0),1:o+(r>1?1:0),2:o+(r>2?1:0),3:o}}if(F(0,t?.[0]),F(1,t?.[1]),F(2,t?.[2]),F(3,t?.[3]),P.active){const{full:n,frac:a}=qt(performance.now()),o=P.total,r=Math.min(o,n);if(r>tt){const u=Math.min(6,r-tt);for(let h=0;h<u;h++)x("deal");tt=r}const s=Math.floor(r/4),l=r%4,c={0:s+(l>0?1:0),1:s+(l>1?1:0),2:s+(l>2?1:0),3:s};e.save(),e.fillStyle="rgba(0,0,0,0.22)",e.fillRect(0,0,I,W),e.fillStyle="#ffffff",e.textAlign="center",e.font="18px system-ui, -apple-system, Segoe UI, sans-serif",e.fillText("Dealing...",500,210),e.restore(),Dt({1:c[1],2:c[2],3:c[3]}),Nt(),Tn(c[0]);const f=r;if(f<o){const u=f%4,h=Math.floor(f/4),d=500,y=350;Bt(d,y);let p;u===m?p=wn(h):p=bn(u,h,13);const k=a,C=_t(d,p.cx,k),v=_t(y,p.cy,k),b=_t(-.15,p.rot,k);ut(C,v,46,66,b)}else P.active=!1,Dt(),Nt(),te();Rt(t),ct();return}Dt(),Nt(),te(),An(),Rt(t),Rt(t),ct()}function Ft(t,n){const a=i.seats[m].hand;for(let o=0;o<a.length;o++){const r=160+o*55,s=520;if(t>=r&&t<=r+48&&n>=s&&n<=s+70)return o}return null}g.addEventListener("mousemove",t=>{if(at())return;const{x:n,y:a}=V(t.clientX,t.clientY),o=Ft(n,a);o!==X&&(X=o,S())});g.addEventListener("mouseleave",()=>{X=null,S()});g.addEventListener("click",t=>{if(at()||i.phase!=="TRICK_PLAY"||i.hand.currentPlayer!==m)return;const{x:n,y:a}=V(t.clientX,t.clientY);if(E(n,a,Te())){Et()?(x("play"),Pe()):x("bad");return}const o=Ft(n,a);if(o===null)return;const r=i.seats[m].hand[o],s=!!r&&Mt(i,m,r);x(s?"ok":"bad"),j=j===o?null:o,S()});g.addEventListener("dblclick",t=>{at()||R||i.phase==="TRICK_PLAY"&&i.hand.currentPlayer===m&&(Et()?(x("play"),Pe()):x("bad"))});S();function Te(){return{x:(I-180)/2,y:390,w:180,h:46}}function Et(){if(i.phase!=="TRICK_PLAY"||!i.hand||i.hand.currentPlayer!==m||j===null)return!1;const t=i.seats[m].hand[j];return Mt(i,m,t)}function Pe(){if(!Et())return;const t=j,n=i.seats[m].hand[t];j=null,A(ke(m,n)),i.phase==="TRICK_PLAY"&&i.hand?.trick.plays.length===4&&Ut(),S()}function An(){if(i.phase!=="TRICK_PLAY"||!i.hand||i.hand.currentPlayer!==m||R||P.active)return;const t=Te(),n=Et();et(t,"PLAY",{enabled:n,variant:n?"gold":"ivory",font:"16px system-ui, -apple-system, Segoe UI, sans-serif"})}function At(){const t=i;return(t.passDir??t.passDirection??t.hand?.passDir)==="HOLD"?0:3}function Cn(){const t=i,n=t.passDir??t.passDirection??t.hand?.passDir;return n==="LEFT"?"Left":n==="RIGHT"?"Right":n==="ACROSS"?"Across":n==="HOLD"?"Hold":""}function vn(){const t=i;return t.hands?.[0]??t.players?.[0]?.hand??i.seats[0].hand??[]}function Mn(){const t=At();if(T.length!==t)return;const n=vn(),a=T.map(o=>n[o]).filter(Boolean);A(Zt(0,a));for(const o of[1,2,3]){const r=xe(xt(i,o),t);A(Zt(o,r))}A({type:"COMMIT_PASS"}),i.phase==="PASS_RESOLVE"&&A({type:"COMMIT_PASS"}),T=[],S()}function En(){if(i.phase!=="PASS_SELECT")return;const t=At(),n=Cn();e.save();const a=e.createLinearGradient(0,0,0,W);a.addColorStop(0,"rgba(0,0,0,0.22)"),a.addColorStop(.5,"rgba(0,0,0,0.14)"),a.addColorStop(1,"rgba(0,0,0,0.22)"),e.fillStyle=a,e.fillRect(0,0,I,W),e.restore();const o=520,r=140,s=(I-o)/2,l=150;e.save(),e.shadowColor="rgba(0,0,0,0.35)",e.shadowBlur=18,e.shadowOffsetY=6,e.fillStyle="rgba(10,48,40,0.62)",N(e,s,l,o,r,18),e.fill(),e.shadowColor="transparent",e.shadowBlur=0,e.lineWidth=1,e.strokeStyle="rgba(255,255,255,0.10)",N(e,s+.5,l+.5,o-1,r-1,18),e.stroke(),e.restore(),e.fillStyle="#ffffff",e.font="18px system-ui, -apple-system, Segoe UI, sans-serif",e.textAlign="center",e.fillText(`Pass${n?" "+n:""} — select ${t} cards`,500,200);const c=T.length===t;et({x:430,y:245,w:140,h:40},"PASS",{enabled:c,variant:c?"gold":"dark",font:"16px system-ui, -apple-system, Segoe UI, sans-serif"});const u=i.seats[0].hand;for(let h=0;h<T.length;h++){const d=T[h];if(d<0||d>=u.length)continue;const y=160+d*55,p=520;e.fillStyle="#ffe08a",e.fillRect(y,p-8,10,6)}}function In(){if(i.phase!=="NEXT_HAND"&&i.phase!=="GAME_OVER")return;e.fillStyle="#000000",e.fillRect(0,0,I,W),e.fillStyle="#ffffff",e.textAlign="center",e.font="22px sans-serif",e.fillText("Hand complete",500,160);const t=[0,1,2,3].map(d=>i.seats[d].handScore).reduce((d,y)=>d+y,0);let n=null;if(t===78){const d=[0,1,2,3].filter(p=>i.seats[p].handScore===0),y=[0,1,2,3].filter(p=>i.seats[p].handScore===26);d.length===1&&y.length===3&&(n=d[0])}n!==null&&(e.font="16px sans-serif",e.fillStyle="#ffe08a",e.fillText(`Shoot the Moon: P${n}`,500,132)),e.font="16px sans-serif",e.fillStyle="#ffffff",e.fillText("This hand / Total",500,190),e.textAlign="left",e.font="18px monospace";const a=[{p:0,this:i.seats[0].handScore,total:i.seats[0].totalScore},{p:1,this:i.seats[1].handScore,total:i.seats[1].totalScore},{p:2,this:i.seats[2].handScore,total:i.seats[2].totalScore},{p:3,this:i.seats[3].handScore,total:i.seats[3].totalScore}],o=360;let r=240;for(const d of a){const p=`${de[d.p].padEnd(8)}  ${String(d.this).padStart(2)}   /   ${String(d.total).padStart(3)}`;n!==null&&d.p===n?e.fillStyle="#ffe08a":e.fillStyle="#ffffff",e.fillText(p,o,r),r+=32}const l=Math.max(...a.map(d=>d.total))>=(i.config?.targetScore??100);if(l){const d=Math.min(...a.map(p=>p.total)),y=a.filter(p=>p.total===d).map(p=>`P${p.p}`).join(", ");e.textAlign="center",e.font="16px sans-serif",e.fillStyle="#ffe08a",e.fillText(`Game over — Winner: ${y}`,500,480),e.fillStyle="#ffffff"}const c=410,f=380,u=180,h=44;l?et({x:c,y:f,w:u,h},"NEW GAME",{variant:"ivory",font:"16px system-ui, -apple-system, Segoe UI, sans-serif"}):et({x:c,y:f,w:u,h},"NEXT HAND",{variant:"gold",font:"18px system-ui, -apple-system, Segoe UI, sans-serif"})}function S(){if(Wt(),!Q){sn(),ct();return}P.active||(En(),In()),ct()}g.addEventListener("click",t=>{if(at()||i.phase!=="PASS_SELECT")return;{const{x:s,y:l}=V(t.clientX,t.clientY);if(E(s,l,pt())||R&&E(s,l,G()))return}t.preventDefault(),t.stopImmediatePropagation?.(),t.stopPropagation();const{x:n,y:a}=V(t.clientX,t.clientY),o=Ft(n,a);if(o!==null){const s=At();T.includes(o)?T=T.filter(l=>l!==o):T.length<s&&T.push(o),S();return}const r=At();n>=430&&n<=570&&a>=260&&a<=300&&T.length===r&&Mn()},!0);g.addEventListener("click",t=>{if(at()||i.phase!=="NEXT_HAND"&&i.phase!=="GAME_OVER")return;{const{x:h,y:d}=V(t.clientX,t.clientY);if(E(h,d,pt())||R&&E(h,d,G()))return}t.preventDefault(),t.stopImmediatePropagation?.(),t.stopPropagation();const{x:n,y:a}=V(t.clientX,t.clientY);x("click");const o=410,r=380,s=180,l=44,c=[0,1,2,3].map(h=>i.seats[h].totalScore),f=i.config?.targetScore??100,u=i.phase==="GAME_OVER"||Math.max(...c)>=f;if(u&&n>=o&&n<=o+s&&a>=r&&a<=r+l){Q=!1,P.active=!1,tt=0,i=dt(String(Date.now())),T=[],X=null,M="",O=!1,S();return}u||n>=o&&n<=o+s&&a>=r&&a<=r+l&&(A({type:"NEXT_HAND"}),A({type:"NEW_HAND"}),Xt(),T=[],X=null,M="",S())},!0);S();function Ln(t){if(t.phase!=="TRICK_PLAY"||!t.hand||!t.hand.trick||t.hand.trick.plays.length!==4)return;const a=t.hand.trick.plays.some(r=>r.card.suit==="H"||r.card.suit==="S"&&r.card.rank===12),o=document.createElement("div");o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.padding="12px 18px",o.style.background="rgba(0,0,0,0.75)",o.style.color="#fff",o.style.borderRadius="6px",o.style.fontSize="16px",o.style.pointerEvents="none",o.style.zIndex="999",o.textContent=a?"Trick ends — points taken":"Trick ends",document.body.appendChild(o),setTimeout(()=>o.remove(),900)}(function(){const n=()=>{try{if(!Q){typeof S=="function"&&S(),requestAnimationFrame(n);return}if(R){typeof S=="function"?S():Wt(),requestAnimationFrame(n);return}Date.now()-me>4500&&(i.phase==="PASS_RESOLVE"?A({type:"COMMIT_PASS"}):i.phase==="TRICK_PLAY"&&i.hand?.trick?.plays?.length===4&&Ut()),typeof S=="function"?S():Wt(),be(),Ln(i)}catch{}requestAnimationFrame(n)};requestAnimationFrame(n)})();
